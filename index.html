<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitor da Gestante — UBS (Supabase + Diagnóstico)</title>

  <!-- Fontes e ícones -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />

  <!-- Supabase (SDK v2) -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --primary:#3C37FF; --primary-700:#2A26C9; --secondary:#008A75; --accent:#FF8A00;
      --bg:#FFFFFF; --text:#0B1220; --muted:#5E6472; --chip:#E6E8EC;
      --ok:#0BAF66; --warn:#D88C00; --bad:#D72638; --card:#FFFFFF; --border:#E3E5EA;
      --focus:#70B5FF; --overlay:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);}
    .app{display:grid;grid-template-columns:340px 1fr;min-height:100vh}
    aside{border-right:1px solid var(--border);padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    main{padding:16px 20px 92px 20px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
    h1{font-size:18px;margin:0;color:var(--primary);font-weight:800;letter-spacing:.2px}
    .mi{font-family:'Material Symbols Rounded';font-size:22px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    label{font-weight:700;font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);font-family:inherit}
    input[type="date"]{padding:8px 10px}
    input:focus, select:focus, button:focus, textarea:focus{outline:2px solid var(--focus); outline-offset: 1px;}
    button{background:var(--primary);color:#fff;border:none;font-weight:800;cursor:pointer}
    button:hover{background:var(--primary-700)}
    button.secondary{background:var(--secondary)}
    button.ghost{background:#fff;color:var(--text);border:1px solid var(--border)}
    button.danger{background:var(--bad)}
    button[disabled]{opacity:.65; cursor:not-allowed}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .col.full{flex:1 0 100%;}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:12px}
    .kpi{background:linear-gradient(180deg, var(--primary), var(--primary-700)); color:white;border-radius:16px;padding:12px}
    .kpi .label{opacity:.95;font-size:12px}
    .kpi .big{font-size:24px;font-weight:800}
    .kpi.alt{background:linear-gradient(180deg, var(--secondary), #006a5a)}
    .kpi.warn{background:linear-gradient(180deg, var(--warn), #9f6500)}
    .kpi.bad{background:linear-gradient(180deg, var(--bad), #921822)}
    .kpi.neutral{background:linear-gradient(180deg, #6B7280, #4B5563)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800;background:var(--chip);color:#111}
    .chip.ok{background:#D9F7E8;color:#055D3A;border:1px solid #96E0C1}
    .chip.bad{background:#FBD6DB;color:#7C0E1A;border:1px solid #F09AA5}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin:10px 0 6px 0}
    .section-title h2{margin:0;font-size:16px}
    .contrast-note{font-size:12px;color:var(--muted)}
    .footer{position:fixed;bottom:0;left:340px;right:0;background:#fff;border-top:1px solid var(--border); padding:8px 16px;display:flex;gap:8px;flex-wrap:wrap;z-index:3}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
    table{width:100%; border-collapse:collapse; font-size:12px}
    th, td{border:1px solid var(--border); padding:6px; text-align:left}
    th{background:#F8F9FB}
    .actions button{margin-right:6px}

    /* Toasts */
    .toast-wrap{position:fixed; right:20px; bottom:20px; z-index:9999; display:flex; flex-direction:column; gap:8px;}
    .toast{display:flex; align-items:center; gap:8px; background:#0BAF66; color:#fff; border-radius:10px; padding:10px 12px; box-shadow:0 6px 24px rgba(0,0,0,.15); font-weight:700; min-width:260px; transition:.25s}
    .toast.err{ background:#D72638; }
    .toast .mi{ font-size:20px; }

    /* Modais */
    .overlay{position:fixed; inset:0; background:var(--overlay); display:none; align-items:center; justify-content:center; z-index:9998;}
    .modal{width:min(820px,96vw); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 12px 48px rgba(0,0,0,.2); padding:16px;}
    .modal header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .modal h3{margin:0; font-size:18px}
    .pill{font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#fff}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .why{font-size:12px; color:var(--muted); margin-top:4px}
    .history{max-height:320px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:8px; background:#fafafa}
    .h-item{padding:8px; border-bottom:1px solid var(--border)}
    .h-item:last-child{border-bottom:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .authbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .authbar input{max-width:220px}
    .auth-badge{font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#fff}
  </style>
</head>
<body>
  <div class="app">
    <aside aria-label="Painel lateral">
      <header>
        <span class="mi" aria-hidden="true">monitor_heart</span><h1>Monitor da Gestante</h1>
      </header>

      <!-- Barra de autenticação -->
      <div class="card">
        <div class="authbar" id="authArea">
          <input id="auth_email" placeholder="e-mail" type="email" />
          <input id="auth_pass" placeholder="senha" type="password" />
          <button class="ghost" id="btnSignup"><span class="mi">person_add</span> Criar conta</button>
          <button class="secondary" id="btnLogin"><span class="mi">login</span> Entrar</button>
          <button class="danger" id="btnLogout" style="display:none"><span class="mi">logout</span> Sair</button>
          <button class="ghost" id="btnDiag"><span class="mi">bug_report</span> Diagnóstico</button>
          <span id="authBadge" class="auth-badge">Não autenticado</span>
        </div>
        <div class="note">Os dados ficam na nuvem (Supabase) e sincronizam entre dispositivos. Cada usuário enxerga apenas seus próprios registros.</div>
      </div>

      <div class="card" aria-labelledby="filtrosTitulo">
        <div class="section-title">
          <h2 id="filtrosTitulo">Filtros</h2>
          <span id="mode" class="pill">Modo: Nuvem</span>
        </div>
        <div class="row">
          <div class="col">
            <label for="f_micro">Microárea</label>
            <select id="f_micro">
              <option value="">Todas</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
          </div>
          <div class="col">
            <label for="f_tipo">Mostrar</label>
            <select id="f_tipo">
              <option value="pendentes">Apenas pendentes</option>
              <option value="todas">Todas</option>
            </select>
          </div>
        </div>
        <div class="search" style="margin-top:8px">
          <input id="f_busca" placeholder="Buscar por nome/CNS/ACS…"/>
          <button class="ghost" id="btnBuscar"><span class="mi">search</span></button>
        </div>
      </div>

      <div class="card" aria-labelledby="cadastroTitulo">
        <div class="section-title"><h2 id="cadastroTitulo">Cadastro / Edição</h2></div>
        <div class="row">
          <div class="col"><label for="cns">CNS*</label><input id="cns"/></div>
          <div class="col"><label for="nome">Nome*</label><input id="nome"/></div>
        </div>
        <div class="row">
          <div class="col"><label for="dum">DUM*</label><input id="dum" type="date"/></div>
          <div class="col">
            <label for="micro">Microárea</label>
            <select id="micro">
              <option value="">Selecione…</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col"><label for="acs">ACS</label><input id="acs"/></div>
          <div class="col"><label for="risco">Risco</label>
            <select id="risco"><option>Baixo</option><option>Alto</option></select>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <div class="col"><label for="cons">Consultas realizadas</label><input id="cons" type="number" min="0"/></div>
          <div class="col"><label for="c1">1ª Consulta (data)</label><input id="c1" type="date"/></div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <div class="col"><label for="sif_ok">Exame Sífilis</label><input id="sif_ok" type="checkbox"/></div>
          <div class="col"><label for="hiv_ok">Exame HIV</label><input id="hiv_ok" type="checkbox"/></div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <div class="col full">
            <label for="usg_data">USG (data)</label>
            <input id="usg_data" type="date"/>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="usg_ig_w">IG na USG (semanas)</label>
            <input id="usg_ig_w" type="number" min="0"/>
          </div>
          <div class="col">
            <label for="usg_ig_d">IG na USG (dias)</label>
            <input id="usg_ig_d" type="number" min="0" max="6"/>
          </div>
        </div>

        <div class="row">
          <div class="col full">
            <label for="odo_ok">Atendimento Odonto</label>
            <input id="odo_ok" type="checkbox"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="secondary" id="btnSalvar"><span class="mi">save</span> <span id="lblSalvar">Salvar/Atualizar</span></button>
          <button class="danger" id="btnExcluir"><span class="mi">delete</span> Excluir</button>
          <button class="ghost" id="btnLimpar"><span class="mi">backspace</span> Limpar</button>
        </div>
        <div class="note" style="margin-top:6px">*CNS, Nome, DUM e Microárea são obrigatórios.</div>
      </div>

      <div class="contrast-note">Os dados são salvos no Supabase (nuvem). As exportações funcionam offline.</div>
    </aside>

    <main aria-label="Conteúdo principal">
      <div class="kpis" role="region">
        <div class="kpi"><div class="label">Gestantes</div><div class="big" id="k_total">—</div></div>
        <div class="kpi alt"><div class="label">IND1 (6 cons. / 1ª ≤12s)</div><div class="big" id="k_p1">—</div></div>
        <div class="kpi warn"><div class="label">IND2 (Sífilis + HIV)</div><div class="big" id="k_p2">—</div></div>
        <div class="kpi bad"><div class="label">IND3 (Odonto)</div><div class="big" id="k_p3">—</div></div>
        <div class="kpi neutral"><div class="label">Alto risco</div><div class="big" id="k_risco">—</div></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="section-title">
          <h2>Gestantes — foco em pendências</h2>
          <div class="chips"><span class="chip ok">OK</span><span class="chip bad">Pendente</span></div>
        </div>
        <table id="tbl">
          <thead>
            <tr>
              <th>CNS</th><th>Nome</th><th>Micro</th><th>ACS</th><th>Risco</th>
              <th>IG DUM</th><th>IG USG</th>
              <th>IND1</th><th>IND2</th><th>IND3</th><th>Status</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Modais (pendências / histórico) omitidos aqui para encurtar; não são necessários p/ inserir -->
  <!-- Se quiser, posso incluir novamente depois que o fluxo de salvar estiver ok -->

  <script>
    // ========= CONFIGURE AQUI =========
    
const SUPABASE_URL = "https://hioodranjyenasgnpern.supabase.co";      // ex: https://abcxyz.supabase.co
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhpb29kcmFuanllbmFzZ25wZXJuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MTc5MDIsImV4cCI6MjA3NTI5MzkwMn0.jevAreEu9ooUrzXYzs8RKL_ZfxJ5hRh2zLgodQPojCc";

    // ========= Utils UI =========
    const $ = sel => document.querySelector(sel);
    function toast(msg, type='ok'){
      const wrap = $('#toasts'); if(!wrap) { alert(msg); return; }
      const el = document.createElement('div');
      el.className = 'toast '+(type==='ok'?'':'err');
      el.innerHTML = '<span class="mi">'+(type==='ok'?'check_circle':'error')+'</span>'+msg;
      wrap.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(10px)'; }, 3000);
      setTimeout(()=>{ wrap.removeChild(el); }, 3600);
    }
    function toastErr(e, fallback='Erro'){
      const msg = (e && (e.message || e.error_description || e.msg)) ? (e.message || e.error_description || e.msg) : fallback;
      console.error('[SUPABASE]', e);
      toast(msg, 'err');
    }

    // ========= Captura global de erros (diagnóstico) =========
    window.addEventListener('error', (e)=>{
      const m = e?.error?.message || e?.message || 'Erro JS';
      toast('Erro: '+m, 'err');
    });
    window.addEventListener('unhandledrejection', (e)=>{
      const r = e?.reason;
      const m = (r && (r.message || r.error_description || r.msg)) ? (r.message || r.error_description || r.msg) : String(r);
      toast('Falha assíncrona: '+m, 'err');
    });

    // ========= Datas & IG =========
    const fmtPct = x => (x*100).toFixed(0)+'%';
    const parseDate = s => s ? new Date(s) : null;
    const daysBetween = (a,b) => Math.floor((b-a)/(1000*60*60*24));
    const weeksBetween = (a,b) => Math.floor(daysBetween(a,b)/7);
    const fmtIGwd = (w,d) => (w==null?'—':`${w} s ${d||0} d`);
    function computeIGbyUSG(usg_date, usg_w, usg_d){
      const d = parseDate(usg_date);
      if(!d || (usg_w==null && usg_d==null)) return {weeks:null, days:null};
      const baseDays = (Number(usg_w)||0)*7 + (Number(usg_d)||0);
      const addDaysNow = daysBetween(d, new Date());
      const total = baseDays + addDaysNow;
      if(total < 0) return {weeks:0, days:0};
      return {weeks: Math.floor(total/7), days: total%7};
    }
    function computeIGbyDUM(dum){
      const d = parseDate(dum); if(!d) return {weeks:null, days:null};
      const diff = daysBetween(d, new Date());
      return {weeks: Math.floor(diff/7), days: diff%7};
    }
    function computeDerived(g){
      const dum = parseDate(g.dum);
      const c1 = parseDate(g.c1);
      const ig_dum = computeIGbyDUM(g.dum);
      const ig_usg = computeIGbyUSG(g.usg_data, g.usg_ig_w, g.usg_ig_d);
      const ind1 = (Number(g.cons||0) >= 6) && (dum && c1 && weeksBetween(dum,c1) <= 12);
      const ind2 = !!g.sif_ok && !!g.hiv_ok;
      const ind3 = !!g.odo_ok;
      const status = (ind1 && ind2 && ind3) ? 'Adequado' : 'Pendente';
      return { ...g, ig_dum, ig_usg, ind1, ind2, ind3, status };
    }
    function withDerivedAll(list){ return list.map(computeDerived); }

    // ========= Verifica SDK Supabase =========
    function ensureSupabase(){
      if (!window.supabase || !window.supabase.createClient){
        toast('SDK do Supabase não carregou. Verifique sua internet/CSP/CDN.', 'err');
        throw new Error('Supabase SDK missing');
      }
    }
    ensureSupabase();

    // ========= Supabase init =========
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const MICRO_LIST = ['1','2','3','4','5','6','7'];

    // ========= Camada de dados (Supabase) =========
    const db = {
      async user(){
        const { data:{ user }, error } = await supabase.auth.getUser();
        if (error) throw error;
        return user;
      },
      async requireAuth(){
        const user = await db.user();
        if(!user){ toast('Entre para usar: dados ficam na nuvem.', 'err'); throw new Error('noauth'); }
        return user;
      },
      async list(){
        const user = await db.requireAuth();
        const { data, error } = await supabase
          .from('gestantes')
          .select('*')
          .eq('owner_uid', user.id)
          .order('updated_at', { ascending:false });
        if(error){ throw error; }
        return data || [];
      },
      async get(cns){
        const user = await db.requireAuth();
        const { data, error } = await supabase
          .from('gestantes')
          .select('*')
          .eq('owner_uid', user.id)
          .eq('cns', cns).maybeSingle();
        if (error) throw error;
        return data || null;
      },
      async upsert(g){
        const user = await db.requireAuth();
        const row = { ...g, owner_uid: user.id, updated_at: new Date().toISOString() };

        // 1) tenta INSERT
        const ins = await supabase.from('gestantes').insert(row);
        if (!ins.error) return;

        // 2) se conflito (23505), UPDATE do próprio dono
        const code = ins.error?.code || ins.error?.details || '';
        const isConflict = String(code).includes('23505') ||
                           String(ins.error?.message || '').toLowerCase().includes('duplicate') ||
                           String(ins.error?.message || '').toLowerCase().includes('conflict');
        if (isConflict) {
          const upd = await supabase
            .from('gestantes')
            .update(row)
            .eq('cns', g.cns)
            .eq('owner_uid', user.id);
          if (upd.error) throw upd.error;
          return;
        }

        // 3) outro erro
        throw ins.error;
      },
      async remove(cns){
        const user = await db.requireAuth();
        const { error } = await supabase
          .from('gestantes')
          .delete()
          .eq('owner_uid', user.id)
          .eq('cns', cns);
        if(error){ throw error; }
      }
    };

    // ========= Validação/Form =========
    function readForm(){
      return {
        cns: $('#cns').value.trim(),
        nome: $('#nome').value.trim(),
        dum: $('#dum').value,
        micro: $('#micro').value.trim(),
        acs: $('#acs').value.trim(),
        risco: $('#risco').value,
        cons: Number($('#cons').value||0),
        c1: $('#c1').value,
        sif_ok: $('#sif_ok').checked,
        hiv_ok: $('#hiv_ok').checked,
        usg_data: $('#usg_data').value,
        usg_ig_w: Number($('#usg_ig_w').value||0),
        usg_ig_d: Number($('#usg_ig_d').value||0),
        odo_ok: $('#odo_ok').checked,
      };
    }
    function validate(g){
      if(!g.cns || !g.nome || !g.dum){ toast('CNS, Nome e DUM são obrigatórios.','err'); return false; }
      if(!g.micro || !MICRO_LIST.includes(String(g.micro))){ toast('Selecione uma microárea de 1 a 7.','err'); return false; }
      return true;
    }

    // ========= Render básico =========
    function chip(val){ const ok=(val==='OK'||val==='Adequado'); return `<span class="chip ${ok?'ok':'bad'}">${val}</span>`; }
    function renderTable(list){
      const tb = $('#tbody'); tb.innerHTML = '';
      for(const g of list){
        const d = computeDerived(g);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${g.cns}</td>
          <td>${g.nome}</td>
          <td>${g.micro||''}</td>
          <td>${g.acs||''}</td>
          <td>${g.risco||'Baixo'}</td>
          <td>${fmtIGwd(d.ig_dum?.weeks, d.ig_dum?.days)}</td>
          <td>${fmtIGwd(d.ig_usg?.weeks, d.ig_usg?.days)}</td>
          <td>${chip(d.ind1?'OK':'Pend.')}</td>
          <td>${chip(d.ind2?'OK':'Pend.')}</td>
          <td>${chip(d.ind3?'OK':'Pend.')}</td>
          <td>${chip(d.status)}</td>
          <td></td>`;
        tb.appendChild(tr);
      }
    }
    async function refreshAll(){
      try{
        const raw = await db.list();
        renderTable(raw);
        $('#k_total').innerText = raw.length;
        const d = withDerivedAll(raw);
        const tot = d.length || 1;
        const p1 = d.filter(x=>x.ind1).length / tot;
        const p2 = d.filter(x=>x.ind2).length / tot;
        const p3 = d.filter(x=>x.ind3).length / tot;
        const alto = d.filter(x=>String(x.risco).toLowerCase()==='alto').length;
        $('#k_p1').innerText = (p1*100|0)+'%';
        $('#k_p2').innerText = (p2*100|0)+'%';
        $('#k_p3').innerText = (p3*100|0)+'%';
        $('#k_risco').innerText = alto;
      }catch(e){
        if(String(e.message).includes('noauth')) return;
        toastErr(e, 'Erro ao carregar lista.');
      }
    }

    // ========= Eventos =========
    window.addEventListener('DOMContentLoaded', async ()=>{
      console.log('DOM pronto');

      // Confere SDK
      if (!window.supabase || !window.supabase.createClient){
        toast('SDK do Supabase não carregou. Cheque a rede/CDN.', 'err');
        return;
      }

      // Auth state
      supabase.auth.onAuthStateChange(async (_evt, session)=>{
        const user = session?.user;
        $('#btnLogout').style.display = user? '' : 'none';
        $('#btnLogin').style.display = user? 'none' : '';
        $('#btnSignup').style.display = user? 'none' : '';
        $('#auth_email').style.display = user? 'none' : '';
        $('#auth_pass').style.display = user? 'none' : '';
        $('#authBadge').textContent = user? `Logado: ${user.email}` : 'Não autenticado';
        if(user){ await refreshAll(); } else { $('#tbody').innerHTML=''; }
      });

      // Auth handlers
      $('#btnSignup').addEventListener('click', async ()=>{
        try{
          const email = $('#auth_email').value.trim();
          const pass = $('#auth_pass').value.trim();
          if(!email || !pass){ toast('Informe e-mail e senha.','err'); return; }
          const { error } = await supabase.auth.signUp({ email, password: pass });
          if(error){ toastErr(error, 'Erro ao criar conta.'); }
          else{ toast('Conta criada. Verifique seu e-mail, se necessário.'); }
        }catch(e){ toastErr(e, 'Erro no signup'); }
      });
      $('#btnLogin').addEventListener('click', async ()=>{
        try{
          const email = $('#auth_email').value.trim();
          const pass = $('#auth_pass').value.trim();
          if(!email || !pass){ toast('Informe e-mail e senha.','err'); return; }
          const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
          if(error){ toastErr(error, 'Login falhou.'); }
          else{ toast('Login ok.'); }
        }catch(e){ toastErr(e, 'Erro no login'); }
      });
      $('#btnLogout').addEventListener('click', async ()=>{
        try{ await supabase.auth.signOut(); toast('Sessão encerrada.'); }
        catch(e){ toastErr(e, 'Erro ao sair'); }
      });

      // Diagnóstico rápido
      $('#btnDiag').addEventListener('click', async ()=>{
        try{
          const { data:{ user } } = await supabase.auth.getUser();
          if(!user){ toast('Você não está logado.','err'); return; }
          toast('Logado como '+user.email);
          const testCns = '__diag__'+Math.random().toString(36).slice(2,7);
          const { error } = await supabase.from('gestantes').insert({
            cns: testCns, owner_uid: user.id, nome: 'DIAG', dum: '2025-01-01', micro: '1'
          });
          if(error){ toastErr(error, 'Falha no INSERT'); }
          else{
            await supabase.from('gestantes').delete().eq('owner_uid', user.id).eq('cns', testCns);
            toast('INSERT permitido (RLS ok).');
          }
        }catch(e){ toastErr(e, 'Diagnóstico falhou'); }
      });

      // Salvar
      $('#btnSalvar').addEventListener('click', async ()=>{
        console.log('Salvar clicado');
        const btn = $('#btnSalvar'), lbl = $('#lblSalvar');
        const g = readForm();
        if(!validate(g)) return;
        try{
          btn.disabled = true; lbl.textContent = 'Salvando...';
          const prev = await db.get(g.cns).catch(err=>{
            // se for noauth, repropaga
            if (String(err?.message).includes('noauth')) throw err;
            // se não existe, ok retornar null
            return null;
          });
          await db.upsert(g);
          await refreshAll();
          toast(prev? 'Atualizado.' : 'Cadastrado.');
          // limpa formulário
          ['cns','nome','dum','acs','c1','usg_data'].forEach(id=>$('#'+id).value='');
          ['micro','risco'].forEach(id=>$('#'+id).selectedIndex=0);
          ['sif_ok','hiv_ok','odo_ok'].forEach(id=>$('#'+id).checked=false);
          ['cons','usg_ig_w','usg_ig_d'].forEach(id=>$('#'+id).value='');
        }catch(e){
          if(String(e.message).includes('noauth')) toast('Faça login para salvar.','err');
          else toastErr(e, 'Erro ao salvar.');
        }finally{
          btn.disabled = false; lbl.textContent = 'Salvar/Atualizar';
        }
      });

      // Excluir (básico, pelo CNS digitado)
      $('#btnExcluir').addEventListener('click', async ()=>{
        const cns = $('#cns').value.trim();
        if(!cns){ toast('Informe o CNS para excluir.','err'); return; }
        if(!confirm('Confirmar exclusão?')) return;
        try{
          await db.remove(cns);
          await refreshAll();
          toast('Registro excluído.');
        }catch(e){ toastErr(e, 'Erro ao excluir.'); }
      });

      $('#btnLimpar').addEventListener('click', ()=>{
        ['cns','nome','dum','acs','c1','usg_data','cons','usg_ig_w','usg_ig_d'].forEach(id=>$('#'+id).value='');
        ['sif_ok','hiv_ok','odo_ok'].forEach(id=>$('#'+id).checked=false);
        ['micro','risco'].forEach(id=>$('#'+id).selectedIndex=0);
      });

      // Primeira atualização (se já estiver logado volta tabela)
      try { await refreshAll(); } catch(_) {}
    });
  </script>

  <!--
  Importante no Supabase (SQL):
  - UPDATE com WITH CHECK:
    drop policy if exists "upd_own" on public.gestantes;
    create policy "upd_own" on public.gestantes
    for update using (owner_uid = auth.uid()) with check (owner_uid = auth.uid());
  -->
</body>
</html>

